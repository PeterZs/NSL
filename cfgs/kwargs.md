# fwd_kwargs
Additional arguments passed to **SlPromptDA** during forward inference.

+ **depth_type**  
    The raw output of SlPromptDA may not be the actual depth. For example, if DPT uses a sigmoid output layer, the output lies in the 0–1 range; if it uses ReLU, the result is any positive value. `depth_type` specifies how to interpret this output and convert it into depth.
    - *no*: No change. The DPT output is treated as depth directly. (You may need to modify the final activation of DPT accordingly.)  
    - *norm_depth*: Depth normalized by `max_depth`. Multiply the DPT output by `max_depth`.  
    - *min_max_ref_depth*: If a reference depth is available (use `{L/R}_Ref_Depth` if present; otherwise use ground truth `{L/R}_Depth`). The DPT output is assumed to be normalized between the min and max of this reference depth.  
    - *linear_scale_ref_depth*: Also requires reference depth (same as above). Linearly scales the DPT output to match the reference depth.  
    - *rel_disp*: Interpolated disparity. Since disparity is large at near distances and small at far distances, a linear interpolation is applied between near and far disparity values. This is a *relative* disparity defined as \(1/\text{depth}\).  
    - *abs_disp*: Similar to above, but disparity is not simplified: \(fb/\text{depth}\), where \(f\) is the top-left element of the intrinsic matrix and \(b\) is the baseline.  
    - *raw_disp*: Raw disparity (large near, small far) without interpolation: \(fb/\text{depth}\).  

    Default: **norm_depth**.

+ **restore_depth**  
    Whether SlPromptDA should recover actual depth values from the raw DPT output according to `depth_type`.  
    Typically **True** during inference.  
    During training, this can be set to **False**, but then you **must** use a **DepthConversion** preprocessing module to convert GTDepth into the corresponding depth representation.  
    Default: **True**.

+ **LCN**  
    Whether to convert images to LCN (Local Contrast Normalization) images when operating between images and patterns. Default: **True**.

+ **get_extra**  
    Whether to return `extra_info` generated by the Prompting Net along with the prompt features. This is currently useful only when using **CostVolume** as the Prompting Net.  
    `extra` is a dictionary (or multiple dictionaries). Possible keys include:

    - `depth`: intermediate depth. When `extra_loss_cfg` is specified in configs, this depth (with `conf`) can be used for auxiliary supervision. Example:
      ```
      extra_loss:
        weight: 1
        gamma: 0.8
        loss:
          extra_l1:
            lambda: 1
            type: DepthL1Loss
          extra_conf:
            lambda: 1
            type: ConfRegLogLoss
      ```
    - `conf`: confidence map accompanying `depth`.
    - `ref_depth`: used as the reference depth for `depth_conversion` during `restore_depth`. This is mainly useful for depth spaces such as `min_max_ref_depth`.  
      When multiple `extra_info` dictionaries are returned, SlPromptDA uses **only the first one** (the one produced by the pattern prompt) for depth restoration.

+ **L_Image_sr**  
    (An attempt to address low-quality RealSense IR images by additionally providing a super-resolved IR image for the second-stage mono-depth refinement.)  
    Not implemented; unused.

+ **RGB_Image**  
    RGB image input for RealSense inference. Can be used as the second-stage input (after aligning stage-1 depth to stage-2).

+ **RGB_intri, R_d2rgb, T_d2rgb**  
    Used for aligning depth to the RGB camera.

+ **align_rgb**  
    Whether to align depth to the RGB camera.

+ **ref_disp**  
    Used when `disparity_models` are applied in the inference model.  
    If provided, it is treated as disparity computed on the reference (far) plane, implying disparity must be negative (consistent with training).  
    During inference, the predicted disparity (absolute value) is added to this `ref_disp`.

+ **corr_middle_rate**
    In the left-right-patt model, overrides the `corr_middle_rate` parameter during forward.

+ **skip_refine**
    Bool, whether to skip the second-stage refiner.

+ **scale_prompt**
    A list of length 2: [range_min, range_max]. The values should be your desired depth range divided by 10. Before injecting the initial depth from the first stage into the second-stage refiner, rescale the initial depth to the specified range.


# fwd_kwargs  
SlPromptDA在forward推理时可以传入的额外参数。  
+ **depth_type**  
    SlPromptDA直接输出的可能不是原始深度，比如，如果在DPT最后使用了sigmoid输出层，则结果分布在0-1范围；如果最后使用relu输出层，则结果是任意正数。depth_type指定要如何使用这个输出，如何将它们转化为深度。  
    - *no*, 没有变化，认为DPT输出结果直接是深度，不做任何变化。可能需要相应的修改DPT最后的激活函数。 
    - norm_depth: 用max_depth归一化后的深度。将DPT输出结果乘以max_depth.  
    - min_max_ref_depth: 如果已知一个参考深度（如果sample中存在`{L/R}_Ref_Depth`，则以之为参考深度，否则直接用GT, `{L/R}_Depth`。认为DPT输出的深度是用直接参考深度的最大最小值归一化后的结果。  
    - linear_scale_ref_depth: 需要参考深度（同上），需要将DPT线性放缩到参考深度上。  
    - rel_disp: 这是插值的视差，由于视差近大远小，所以算出视差后在near的视差和far的视差间取线性插值。rel_disp是一种相对视差，视差简化为 $1/depth$.  
    - abs_disp: 同上，但视差没有简化，是$fb/depsh$, 其中f是内参矩阵左上角元素，b是基线距离。  
    - raw_disp: 近大远小的原始视差，没有插值，是$fb/depth$.  

    默认为norm_depth.  
+ **restore_depth**  
    SlPromptDA在输出的时候是否需要将DPT原始结果根据depth_type恢复为深度。一般推理的时候是True。训练的时候可以设置为False，但必须要配置使用**DepthConversion**相关的预处理模块把GTDepth转化到相应的深度空间。  
    默认是True.  
+ **LCN**  
    在images和pattern之间进行操作时，是否将images转化为LCN图，默认为True.  
+ **get_extra**  
    是否要获取 Prompting Net 随Prompt特征输出的extra_info，目前只在以CostVolume作为promptint Net的时候有用。  
    返回的extra是个字典，也可以是多个字典，这些字典的key可以是：  
    `depth`: 表示中间深度，可以和conf配合，在configs里指定了extra_loss_cfg的话，可以用这个depth和conf来做额外的监督，extra_loss_cfg如下例：
    ```
    extra_loss:
    weight: 1
    gamma: 0.8
    loss: 
      extra_l1: 
        lambda: 1
        type: DepthL1Loss
      extra_conf:
        lambda: 1
        type: ConfRegLogLoss
    ```  
    `conf`，与`depth`配合进行额外监督。  
    `ref_depth`, 在restore_depth的时候作为ref_depth输入`depth_conversion`方程，这主要针对使用`min_max_ref_depth`这类深度空间进行推理的时候有用。在有多个extra_info输出出来的时候，sl_prompt_da在进行depth_restoration的时候会用第一个（即仅用pattern_prompt输出出来的那个）

+ **L_Image_sr**
  (尝试应对realsense的低质量ir图，可以同步传入一个经过超分修复的高质量ir图，第二阶段mono depth refinement 的时候将用它作为输入)；无用，未实现.

+ **RGB_Image**
  realsense推理的时候传入rgb图，可以用它作为第二阶段的输入（提前将一阶段深度对齐到二阶段）  

+ **RGB_intri, R_d2rgb, T_d2rgb**
  将深度对齐到rgb相机的时候用的.

+ **align_rgb**
  将深度对齐到rgb相机

+ **ref_disp**
  在inference_model的disparity_models用，如果有，视作在参考平面上做双目匹配，且认为这个参考平面是far plane，也就是认为视差是必须是负数（和训练情况一致），此时要将ref_disp加上推理的视差（绝对值）

+ **corr_middle_rate**:
  left-right-patt模型中，在forward的时候覆盖掉 corr_middle_rate 参数。

+ **skip_refine**
  bool，是否跳过第二阶段refiner.  

+ **scale_prompt**
  长度为2的列表 `[range_min, range_max]，数值应该是你希望的深度范围 / 10`，在将第一阶段初始深度注入第二阶段refiner前，rescale 初始深度到指定范围。  